{% extends 'base.html' %}
{% load static %}
{% block title %}User Database{% endblock %}
{% block content %}
<div class="container">
  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
      <h1 style="margin:0;">User Database</h1>
      <input id="searchInput" type="text" placeholder="Search" style="max-width: 280px; width:100%; padding: .5rem .75rem; border:1px solid #ccc; border-radius:6px;" />
    </div>

    {% if user.is_mall_owner %}
    <!-- Mall Owner view: pull users from Firebase RTDB (/users) -->
    <table style="margin-top: 1rem;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Contact Number</th>
          <th>User Type</th>
          <th>PWD Status</th>
          <th>QR Data</th>
          <th>Active Transaction</th>
        </tr>
      </thead>
      <tbody id="fbUsersBody">
        <tr><td colspan="7" style="text-align:center;color:#777;">Loading from Firebase…</td></tr>
      </tbody>
    </table>
    {% else %}
    <!-- Admin view: show only users who have entered (occupied slots) -->
    <table style="margin-top: 1rem;">
      <thead>
        <tr>
          <th>Username</th>
          <th>Contact Number</th>
          <th>Slot</th>
          <th>User Type</th>
          <th>Active Transaction</th>
        </tr>
      </thead>
      <tbody id="adminUsersBody">
        <tr><td colspan="5" style="text-align:center;color:#777;">Loading active parkers…</td></tr>
      </tbody>
    </table>
    {% endif %}
  </div>
</div>

{% if user.is_mall_owner %}
<script type="module">
  import { firebaseConfig } from "{% static 'js/firebaseConfig.js' %}";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const appMall = initializeApp(firebaseConfig, 'mall');
  const dbMall = getDatabase(appMall);
 
  const tbody = document.getElementById('fbUsersBody');
  const searchEl = document.getElementById('searchInput');

  let usersData = {};
  let txStatusByUid = {};

  function computeTxStatusMap(transactions) {
    const map = {};
    for (const [txId, t] of Object.entries(transactions || {})) {
      const uid = t?.uid;
      if (!uid) continue;
      const status = (t?.status || '').toUpperCase();
      if (status === 'ONGOING') { map[uid] = 'ONGOING'; continue; }
      if (!map[uid] && (status === 'PAID' || status === 'COMPLETED')) { map[uid] = 'PAID'; }
    }
    return map;
  }

  function render() {
    const term = (searchEl.value || '').toLowerCase();
    const rows = Object.entries(usersData).map(([uid, u]) => {
      const displayName = u.displayName || '';
      const email = u.email || '';
      const contact = u.contactNumber || '';
      const userType = u.isPWD ? 'pwd' : 'regular';
      const pwdStatus = u.pwdStatus || 'none';
      const qrData = u.qrData || '';
      let activeState = 'NONE';
      const explicit = u.activeTransaction;
      if (explicit) { activeState = txStatusByUid[uid] || 'ONGOING'; }
      else { activeState = txStatusByUid[uid] || 'NONE'; }

      const rowText = `${displayName} ${email} ${contact} ${userType} ${pwdStatus} ${qrData} ${activeState}`.toLowerCase();
      if (term && !rowText.includes(term)) return '';
      return `<tr>
        <td>${displayName}</td>
        <td>${email}</td>
        <td>${contact}</td>
        <td>${userType}</td>
        <td>${pwdStatus}</td>
        <td>${qrData}</td>
        <td>${activeState}</td>
      </tr>`;
    }).filter(Boolean);
    tbody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="7" style="text-align:center;color:#777;">No users found.</td></tr>`;
  }

  onValue(ref(dbMall, '/users'), (snap) => { usersData = snap.val() || {}; render(); });
  onValue(ref(dbMall, '/transactions'), (snap) => { txStatusByUid = computeTxStatusMap(snap.val()); render(); });
  searchEl.addEventListener('input', render);

  // Client-side search
  document.getElementById('searchInput').addEventListener('input', () => {
    // Trigger re-render by reusing the onValue snapshot (simple approach: let next RTDB event refresh)
    // For immediate filter, we can re-run onValue handler logic by reading current table and hiding rows
    const term = (document.getElementById('searchInput').value || '').toLowerCase();
    Array.from(document.querySelectorAll('#fbUsersBody tr')).forEach(tr => {
      tr.style.display = tr.innerText.toLowerCase().includes(term) ? '' : 'none';
    });
  });
</script>
{% endif %}

{% if user.is_admin and not user.is_mall_owner %}
<script type="module">
  import { firebaseConfig } from "{% static 'js/firebaseConfig.js' %}";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const appAdmin = initializeApp(firebaseConfig, 'admin');
  const dbAdmin = getDatabase(appAdmin);

  const tbodyAdmin = document.getElementById('adminUsersBody');
  const searchElAdmin = document.getElementById('searchInput');

  let occupied = {};     // configurations/layout/occupied
  let usersMap = {};     // users
  let txMap = {};        // transactions

  function renderAdmin() {
    const term = (searchElAdmin.value || '').toLowerCase();
    const rows = Object.entries(occupied)
      .filter(([key, occ]) => {
        const st = (occ?.status || '').toString().toUpperCase();
        return st === 'OCCUPIED';
      })
      .map(([key, occ]) => {
        const uid = occ?.uid || '';
        const slotName = occ?.slotName || key;
        const txId = occ?.txId || (usersMap[uid]?.activeTransaction || '');
        const u = usersMap[uid] || {};
        const name = u.displayName || u.email || uid;
        const contact = u.contactNumber || '';
        const userType = u.isPWD ? 'pwd' : 'regular';
        const activeState = txId && txMap[txId] && (txMap[txId].status || '').toString().toUpperCase() === 'ONGOING' ? 'ONGOING' : (txId ? 'PAST' : 'NONE');
        const rowText = `${name} ${contact} ${slotName} ${userType} ${activeState}`.toLowerCase();
        if (term && !rowText.includes(term)) return '';
        return `<tr>
          <td>${name}</td>
          <td>${contact}</td>
          <td>${slotName}</td>
          <td>${userType}</td>
          <td>${txId ? txId + ' (' + activeState + ')' : 'NONE'}</td>
        </tr>`;
      })
      .filter(Boolean);
    tbodyAdmin.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="5" style="text-align:center;color:#777;">No occupied slots.</td></tr>`;
  }

  onValue(ref(dbAdmin, '/configurations/layout/occupied'), (snap) => { occupied = snap.val() || {}; renderAdmin(); });
  onValue(ref(dbAdmin, '/users'), (snap) => { usersMap = snap.val() || {}; renderAdmin(); });
  onValue(ref(dbAdmin, '/transactions'), (snap) => { txMap = snap.val() || {}; renderAdmin(); });
  searchElAdmin.addEventListener('input', renderAdmin);
</script>
{% endif %}
{% endblock %}
{% extends 'base.html' %}
{% load static %}
{% block title %}Monitor{% endblock %}
{% block content %}
<div class="container">
  {% if generated %}
    <h2>Generated Parking Layout</h2>
    <p>Total Floors: {{ floors }}</p>
    {% for floor, types in layout.items %}
      <h3>Floor {{ floor }}</h3>
      {% for label, slot_list in types.items %}
        <h4 style="margin-top:1rem;">{{ label }} Slots</h4>
        <div class="slot-grid">
          {% for slot_name, user_info in slot_list %}
            <div class="slot-box"
                 data-slot="{{ slot_name }}"
                 data-type="{{ label }}"
                 tabindex="0">{{ slot_name }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <hr>
    {% endfor %}

    <a href="{% url 'register_slots' %}"
       class="nav-link"
       style="display:inline-block;margin-top:2rem;background:#e8b931;color:#000;padding:0.5rem 1rem;border-radius:6px;">
      ‚Üê Back to Form
    </a>

    {% if user.is_mall_owner %}
    <button id="save-layout-btn" type="button" class="nav-link" style="display:inline-block;margin-top:2rem;margin-left:.5rem;background:#333;color:#fff;padding:0.5rem 1rem;border-radius:6px;opacity:.6;cursor:not-allowed;">Save Changes</button>
    {% endif %}
    <div id="custom-context-menu">
      {% if user.is_mall_owner %}<div id="edit-option">‚úèÔ∏è Edit Slot Name</div>{% endif %}
    </div>
  {% else %}
    <p>No layout generated yet. Please register slots first.</p>
  {% endif %}
</div>

<!-- Top-right slot summary -->
<div id="slot-summary" class="slot-summary" aria-live="polite">
  <div class="sum-title">Slots left</div>
  <div class="sum-item"><span class="sum-label">Car</span><span id="sum-car-left" class="sum-value">‚Äì</span></div>
  <div class="sum-item"><span class="sum-label">Motorcycle</span><span id="sum-motor-left" class="sum-value">‚Äì</span></div>
  <div class="sum-item"><span class="sum-label">PWD</span><span id="sum-pwd-left" class="sum-value">‚Äì</span></div>
</div>

<!-- User Details Modal (full) -->
<div id="user-details-overlay" class="overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-avatar">üë§</div>
    <div class="modal-row"><span class="label">Full Name</span><span id="m-name">N/A</span></div>
    <div class="modal-row"><span class="label">Contact No:</span><span id="m-contact">N/A</span></div>
    <div class="modal-row"><span class="label">User Type</span><span id="m-type">N/A</span></div>
    <div class="modal-row"><span class="label">Time-In</span><span id="m-time">N/A</span></div>
    <div class="modal-row"><span class="label">Time Left</span><span id="m-time-left">‚Äî</span></div>
    <div class="modal-row"><span class="label">Closing Deadline</span><span id="m-deadline">‚Äî</span></div>
    <div class="modal-row"><span class="label">Violation Notice</span><span id="m-violation-status">None</span></div>
    <div class="modal-action-row">
      <button id="send-violation-btn" class="btn btn-alert" type="button">Send Violation Notice</button>
      <button id="stop-violation-btn" class="btn btn-cancel" type="button" style="display:none;">Stop Notice</button>
    </div>
    <button id="modal-close" class="btn-close">Close</button>
  </div>
 </div>

<!-- Lightweight hover details (non-intrusive) -->
<div id="hover-details" aria-hidden="true">
  <div id="hd-name" class="hd-row hd-name">Loading‚Ä¶</div>
  <div class="hd-row"><span class="hd-label">Contact:</span><span id="hd-contact"></span></div>
  <div class="hd-row"><span class="hd-label">Type:</span><span id="hd-type"></span></div>
  <div class="hd-row"><span class="hd-label">Time-In:</span><span id="hd-time"></span></div>
  <div class="hd-row"><span class="hd-label">Time Left:</span><span id="hd-time-left"></span></div>
</div>

<!-- Save toast notification -->
<div id="save-toast" class="toast" role="status" aria-live="polite"></div>

<div id="cfg"
     data-can-edit="{{ user.is_mall_owner|yesno:'true,false' }}"
     data-save-url="{% url 'save_layout_labels' %}"
     data-admin-email="{{ request.user.email }}"></div>

<div id="violation-modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-box">
    <h3 style="margin-top:0;">Send Violation Notice</h3>
    <p class="modal-help">Enter a short message (max 50 characters). The user will see it every 3 minutes until stopped.</p>
    <textarea id="violation-message-input" maxlength="50" placeholder="Describe the violation"></textarea>
    <div class="modal-count"><span id="violation-char-count">0 / 50</span></div>
    <div class="modal-actions">
      <button type="button" id="violation-cancel-btn" class="secondary">Cancel</button>
      <button type="button" id="violation-send-btn" class="btn-alert">Send Notice</button>
    </div>
  </div>
</div>

<script type="module" src="{% static 'js/monitor.js' %}"></script>

<script>
// Minimal inline close handlers to ensure modal closes reliably
document.addEventListener('DOMContentLoaded', function(){
  var overlay = document.getElementById('user-details-overlay');
  var btn = document.getElementById('modal-close');
  if (btn) {
    btn.addEventListener('click', function(e){
      e.preventDefault();
      if (!overlay) return;
      if (window.clearMonitorSelection) { window.clearMonitorSelection(); }
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    });
  }
  if (overlay) {
    overlay.addEventListener('click', function(e){
      if (e.target === overlay) {
        if (window.clearMonitorSelection) { window.clearMonitorSelection(); }
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
      }
    });
  }
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      if (!overlay) return;
      if (window.clearMonitorSelection) { window.clearMonitorSelection(); }
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    }
  });
});
</script>

<style>
.slot-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:10px; margin-bottom:1rem; }
.slot-box{ text-align:center; padding:.5rem; border:1px solid #7ac27a; border-radius:6px; font-weight:bold; background:#d5f5d5; user-select:none; transition:background-color .15s ease, border-color .15s ease; }
.slot-box:focus{ outline:2px solid #e8b931; }
#custom-context-menu { display: none; position: absolute; z-index: 1600; background: white; border: 1px solid #ccc; box-shadow: 0 8px 24px rgba(0,0,0,0.18); border-radius: 6px; font-size: 14px; overflow: hidden; }
#custom-context-menu div { padding: 10px 16px; cursor: pointer; }
#custom-context-menu div:hover { background-color: #f0f0f0; }
.overlay{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.35); z-index: 1200; align-items:center; justify-content:center; padding: 1rem; }
.modal-card{ background:#fff; width: 520px; max-width: 92vw; border-radius: 12px; padding: 1.5rem 2rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
.modal-avatar{ font-size: 48px; text-align:center; margin-bottom: .75rem; }
.modal-row{ display:flex; justify-content:space-between; padding:.35rem 0; border-bottom:1px solid #eee; }
.modal-row .label{ color:#777; margin-right:1rem; }
.btn-close{ margin-top:1rem; width:100%; padding:.6rem .8rem; border:none; border-radius:8px; background:#e8b931; color:#000; font-weight:700; cursor:pointer; }
.toast{ display:none; position:fixed; right:22px; bottom:22px; background:#333; color:#fff; padding:.6rem .9rem; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.25); z-index:1300; }

/* Shared small buttons */
.btn{ padding:.45rem .8rem; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
.btn-save{ background:#e7f8ed; color:#0e7a3d; }
.btn-cancel{ background:#fff1cf; color:#9a6a00; }
.btn-alert{ background:#ffeec4; color:#7a4000; }

.modal-action-row{ display:flex; flex-wrap:wrap; gap:.75rem; margin-top:.85rem; }
.modal-action-row .btn{ flex:1 1 160px; }
.modal-actions{ display:flex; gap:.75rem; justify-content:center; margin-top:1.1rem; }
.modal-actions .secondary{ background:#f3f3f3; color:#333; border:none; padding:.45rem .9rem; border-radius:8px; font-weight:600; cursor:pointer; }
.modal-help{  text-align: center; margin:.35rem 0; color:#555; font-size:14px; }
.modal-actions button { min-width: 130px;}
.modal-count{ margin-top:.35rem; text-align:right; font-size:12px; color:#777; }
.modal-box{ text-align: center; background:#fff; width:100%; max-width:420px; border-radius:12px; padding:1.4rem 1.8rem; box-shadow:0 18px 38px rgba(0,0,0,.28); position:relative; z-index:1; }
.modal-box textarea{ text-align: left; width:100%; min-height:90px; border:1px solid #ddd; margin:0 auto;  box-sizing:border-box; border-radius:10px; padding:.7rem; resize:vertical; font-family:inherit; }
.modal-box textarea:focus{ outline:2px solid #e8b931; border-color:#e8b931; }
.modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; background:rgba(0,0,0,.45); z-index:1400; }
.modal-backdrop.show{ display:flex; }
.btn-alert:hover{ filter:brightness(.98); }
.text-danger{ color:#b40000; font-weight:700; }

/* Hover details card */
#hover-details{ display:none; position:absolute; z-index:1100; pointer-events:none; width:280px; max-width:80vw; background:#fff; border:1px solid #ddd; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.18); padding:.75rem .9rem; }
#hover-details .hd-row{ display:flex; justify-content:space-between; gap:.5rem; padding:.2rem 0; }
#hover-details .hd-name{ font-weight:700; justify-content:flex-start; }
#hover-details .hd-label{ color:#777; min-width:84px; }

/* Slot summary panel */
.slot-summary{ position: fixed; right: 24px; top: 24px; z-index: 1100; background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:.75rem 1rem; min-width: 180px; }
.slot-summary .sum-title{ font-weight:700; margin-bottom:.35rem; color:#333; }
.slot-summary .sum-item{ display:flex; align-items:center; justify-content:space-between; padding:.15rem 0; }
.slot-summary .sum-label{ color:#777; }
.slot-summary .sum-value{ font-weight:700; }
</style>
{% endblock %}
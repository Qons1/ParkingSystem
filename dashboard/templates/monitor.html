{% extends 'base.html' %}
{% load static %}
{% block title %}Monitor{% endblock %}
{% block content %}
<div class="container">
  {% if generated %}
    <h2>Generated Parking Layout</h2>
    <p>Total Floors: {{ floors }}</p>
    {% for floor, types in layout.items %}
      <h3>Floor {{ floor }}</h3>
      {% for label, slot_list in types.items %}
        <h4 style="margin-top:1rem;">{{ label }} Slots</h4>
        <div class="slot-grid">
          {% for slot_name, user_info in slot_list %}
            <div class="slot-box"
                 data-slot="{{ slot_name }}"
                 data-type="{{ label }}"
                 tabindex="0">{{ slot_name }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <hr>
    {% endfor %}

    <a href="{% url 'register_slots' %}"
       class="nav-link"
       style="display:inline-block;margin-top:2rem;background:#e8b931;color:#000;padding:0.5rem 1rem;border-radius:6px;">
      ‚Üê Back to Form
    </a>

    {% if user.is_mall_owner %}
    <button id="save-layout-btn" type="button" class="nav-link" style="display:inline-block;margin-top:2rem;margin-left:.5rem;background:#333;color:#fff;padding:0.5rem 1rem;border-radius:6px;opacity:.6;cursor:not-allowed;">Save Changes</button>
    {% endif %}
    <div id="custom-context-menu">
      {% if user.is_mall_owner %}<div id="edit-option">‚úèÔ∏è Edit Slot Name</div>{% endif %}
    </div>
  {% else %}
    <p>No layout generated yet. Please register slots first.</p>
  {% endif %}
</div>

<!-- Top-right slot summary -->
<div id="slot-summary" class="slot-summary" aria-live="polite">
  <div class="sum-title">Slots left</div>
  <div class="sum-item"><span class="sum-label">Car</span><span id="sum-car-left" class="sum-value">‚Äì</span></div>
  <div class="sum-item"><span class="sum-label">Motorcycle</span><span id="sum-motor-left" class="sum-value">‚Äì</span></div>
  <div class="sum-item"><span class="sum-label">PWD</span><span id="sum-pwd-left" class="sum-value">‚Äì</span></div>
</div>

<!-- User Details Modal (full) -->
<div id="user-details-overlay" class="overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-avatar">üë§</div>
    <div class="modal-row"><span class="label">Full Name</span><span id="m-name">N/A</span></div>
    <div class="modal-row"><span class="label">Contact No:</span><span id="m-contact">N/A</span></div>
    <div class="modal-row"><span class="label">User Type</span><span id="m-type">N/A</span></div>
    <div class="modal-row"><span class="label">Time-In</span><span id="m-time">N/A</span></div>
    <button id="modal-close" class="btn-close">Close</button>
  </div>
 </div>

<!-- Lightweight hover details (non-intrusive) -->
<div id="hover-details" aria-hidden="true">
  <div id="hd-name" class="hd-row hd-name">Loading‚Ä¶</div>
  <div class="hd-row"><span class="hd-label">Contact:</span><span id="hd-contact"></span></div>
  <div class="hd-row"><span class="hd-label">Type:</span><span id="hd-type"></span></div>
  <div class="hd-row"><span class="hd-label">Time-In:</span><span id="hd-time"></span></div>
</div>

<!-- Save toast notification -->
<div id="save-toast" class="toast" role="status" aria-live="polite"></div>

<div id="cfg" data-can-edit="{{ user.is_mall_owner|yesno:'true,false' }}" data-save-url="{% url 'save_layout_labels' %}"></div>
<script type="module" src="{% static 'js/monitor.js' %}"></script>
<script>
// Minimal inline close handlers to ensure modal closes reliably
document.addEventListener('DOMContentLoaded', function(){
  var overlay = document.getElementById('user-details-overlay');
  var btn = document.getElementById('modal-close');
  if (btn) {
    btn.addEventListener('click', function(e){
      e.preventDefault();
      if (!overlay) return;
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    });
  }
  if (overlay) {
    overlay.addEventListener('click', function(e){
      if (e.target === overlay) {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
      }
    });
  }
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      if (!overlay) return;
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    }
  });
});
</script>

<style>
.slot-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:10px; margin-bottom:1rem; }
.slot-box{ text-align:center; padding:.5rem; border:1px solid #ccc; border-radius:6px; font-weight:bold; background:#f7f7f7; user-select:none; }
.slot-box:focus{ outline:2px solid #e8b931; }
#custom-context-menu { display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 6px; font-size: 14px; overflow: hidden; }
#custom-context-menu div { padding: 10px 16px; cursor: pointer; }
#custom-context-menu div:hover { background-color: #f0f0f0; }
.overlay{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.35); z-index: 1200; align-items:center; justify-content:center; padding: 1rem; }
.modal-card{ background:#fff; width: 520px; max-width: 92vw; border-radius: 12px; padding: 1.5rem 2rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
.modal-avatar{ font-size: 48px; text-align:center; margin-bottom: .75rem; }
.modal-row{ display:flex; justify-content:space-between; padding:.35rem 0; border-bottom:1px solid #eee; }
.modal-row .label{ color:#777; margin-right:1rem; }
.btn-close{ margin-top:1rem; width:100%; padding:.6rem .8rem; border:none; border-radius:8px; background:#e8b931; color:#000; font-weight:700; cursor:pointer; }
.toast{ display:none; position:fixed; right:22px; bottom:22px; background:#333; color:#fff; padding:.6rem .9rem; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.25); z-index:1300; }

/* Hover details card */
#hover-details{ display:none; position:absolute; z-index:1100; pointer-events:none; width:280px; max-width:80vw; background:#fff; border:1px solid #ddd; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.18); padding:.75rem .9rem; }
#hover-details .hd-row{ display:flex; justify-content:space-between; gap:.5rem; padding:.2rem 0; }
#hover-details .hd-name{ font-weight:700; justify-content:flex-start; }
#hover-details .hd-label{ color:#777; min-width:84px; }

/* Slot summary panel */
.slot-summary{ position: fixed; right: 24px; top: 24px; z-index: 1100; background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:.75rem 1rem; min-width: 180px; }
.slot-summary .sum-title{ font-weight:700; margin-bottom:.35rem; color:#333; }
.slot-summary .sum-item{ display:flex; align-items:center; justify-content:space-between; padding:.15rem 0; }
.slot-summary .sum-label{ color:#777; }
.slot-summary .sum-value{ font-weight:700; }
</style>
{% endblock %}
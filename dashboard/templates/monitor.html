{% extends 'base.html' %}
{% load static %}
{% block title %}Monitor{% endblock %}
{% block content %}
<div class="container">
  {% if generated %}
    <h2>Generated Parking Layout</h2>
    <p>Total Floors: {{ floors }}</p>
    {% for floor, types in layout.items %}
      <h3>Floor {{ floor }}</h3>
      {% for label, slot_list in types.items %}
        <h4 style="margin-top:1rem;">{{ label }} Slots</h4>
        <div class="slot-grid">
          {% for slot_name, user_info in slot_list %}
            <div class="slot-box"
                 data-slot="{{ slot_name }}"
                 data-user="{{ user_info|linebreaksbr }}"
                 tabindex="0">{{ slot_name }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <hr>
    {% endfor %}

    <a href="{% url 'register_slots' %}"
       class="nav-link"
       style="display:inline-block;margin-top:2rem;background:#e8b931;color:#000;padding:0.5rem 1rem;border-radius:6px;">
      ‚Üê Back to Form
    </a>

    {% if user.is_mall_owner %}
    <button id="save-layout-btn" type="button" class="nav-link" style="display:inline-block;margin-top:2rem;margin-left:.5rem;background:#333;color:#fff;padding:0.5rem 1rem;border-radius:6px;opacity:.6;cursor:not-allowed;">Save Changes</button>
    <div id="custom-context-menu">
      <div id="edit-option">‚úèÔ∏è Edit Slot Name</div>
      <div id="details-option">üë§ View User Details</div>
    </div>
    {% endif %}
  {% else %}
    <p>No layout generated yet. Please register slots first.</p>
  {% endif %}
</div>

<!-- User Details Modal -->
<div id="user-details-overlay" class="overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-avatar">üë§</div>
    <div class="modal-row"><span class="label">Full Name</span><span id="m-name">N/A</span></div>
    <div class="modal-row"><span class="label">Contact No:</span><span id="m-contact">N/A</span></div>
    <div class="modal-row"><span class="label">User Type</span><span id="m-type">N/A</span></div>
    <div class="modal-row"><span class="label">Time-In</span><span id="m-time">N/A</span></div>
    <button id="modal-close" class="btn-close">Close</button>
  </div>
 </div>

<div id="save-toast" class="toast" aria-live="polite">Changes saved (placeholder ‚Äî not yet connected)</div>

{% if user.is_mall_owner %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menu = document.getElementById("custom-context-menu");
  const saveBtn = document.getElementById("save-layout-btn");
  let selectedSlot = null;
  let hasUnsaved = false;

  function enableSave() {
    if (!saveBtn) return;
    hasUnsaved = true;
    saveBtn.style.opacity = '1';
    saveBtn.style.cursor = 'pointer';
    saveBtn.disabled = false;
  }

  document.querySelectorAll(".slot-box").forEach(box => {
    box.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      selectedSlot = box;
      menu.style.display = "block";
      menu.style.left = `${e.pageX}px`;
      menu.style.top = `${e.pageY}px`;
    });
    box.addEventListener("dblclick", () => {
      box.contentEditable = box.isContentEditable ? "false" : "true";
      box.focus();
    });
    box.addEventListener("blur", () => {
      if (box.isContentEditable) enableSave();
    });
  });

  document.addEventListener("click", () => {
    menu.style.display = "none";
  });

  document.getElementById("edit-option").addEventListener("click", () => {
    if (selectedSlot) {
      selectedSlot.contentEditable = "true";
      selectedSlot.focus();
    }
    menu.style.display = "none";
  });

  document.getElementById("details-option").addEventListener("click", () => {
    if (selectedSlot) {
      openDetails(selectedSlot);
    }
    menu.style.display = "none";
  });

  if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
      if (!hasUnsaved) return;
      const labels = {};
      document.querySelectorAll('.slot-box').forEach(el => {
        const slotId = el.dataset.slot;
        const name = el.textContent.trim();
        if (slotId && name) labels[slotId] = name;
      });
      try {
        const res = await fetch("{% url 'save_layout_labels' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ labels })
        });
        let ok = res.ok; let errMsg = '';
        try {
          const j = await res.json();
          if (j && j.ok === false) { ok = false; errMsg = j.error || ''; }
        } catch (_) {}
        const toast = document.getElementById('save-toast');
        toast.textContent = ok ? 'Changes saved to Firebase' : ('Save failed' + (errMsg ? (': ' + errMsg) : ''));
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1600);
        if (ok) {
          hasUnsaved = false;
          saveBtn.style.opacity = '.6';
          saveBtn.style.cursor = 'not-allowed';
          saveBtn.disabled = true;
        }
      } catch (e) {
        const toast = document.getElementById('save-toast');
        toast.textContent = 'Save failed';
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1600);
      }
    });
  }

  function openDetails(slotEl){
    const overlay = document.getElementById('user-details-overlay');
    const userRaw = (slotEl.dataset.user || '').replace(/<br\s*\/??\>/gi, '\n');
    const lines = userRaw.split(/\n+/).map(s => s.trim()).filter(Boolean);
    document.getElementById('m-name').textContent = lines[0] || 'N/A';
    document.getElementById('m-contact').textContent = lines[1] || 'N/A';
    document.getElementById('m-type').textContent = lines[2] || 'N/A';
    document.getElementById('m-time').textContent = lines[3] || 'N/A';
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
  }

  document.getElementById('modal-close').addEventListener('click', () => {
    const overlay = document.getElementById('user-details-overlay');
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
  });
});
</script>
{% endif %}
<style>
.slot-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
  gap:10px;
  margin-bottom:1rem;
}
.slot-box{
  text-align:center;
  padding:.5rem;
  border:1px solid #ccc;
  border-radius:6px;
  font-weight:bold;
  background:#f7f7f7;
  user-select:none;
}
.slot-box:focus{ outline:2px solid #e8b931; }
#custom-context-menu {
  display: none;
  position: absolute;
  z-index: 1000;
  background: white;
  border: 1px solid #ccc;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-radius: 6px;
  font-size: 14px;
  overflow: hidden;
}
#custom-context-menu div { padding: 10px 16px; cursor: pointer; }
#custom-context-menu div:hover { background-color: #f0f0f0; }

/* Modal */
.overlay{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.35); z-index: 1200; align-items:center; justify-content:center; padding: 1rem; }
.modal-card{ background:#fff; width: 520px; max-width: 92vw; border-radius: 12px; padding: 1.5rem 2rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
.modal-avatar{ font-size: 48px; text-align:center; margin-bottom: .75rem; }
.modal-row{ display:flex; justify-content:space-between; padding:.35rem 0; border-bottom:1px solid #eee; }
.modal-row .label{ color:#777; margin-right:1rem; }
.btn-close{ margin-top:1rem; width:100%; padding:.6rem .8rem; border:none; border-radius:8px; background:#e8b931; color:#000; font-weight:700; cursor:pointer; }

/* Toast */
.toast{ display:none; position:fixed; right:22px; bottom:22px; background:#333; color:#fff; padding:.6rem .9rem; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.25); z-index:1300; }
</style>
{% endblock %}
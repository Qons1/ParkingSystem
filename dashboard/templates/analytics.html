{% extends 'base.html' %}
{% load static %}
{% block title %}Analytics{% endblock %}
{% block content %}
<div class="container">
  <div class="card">
    <!-- KPI Row (simplified; removed Entries Today and Currently Occupied) -->
    <div style="display:flex; gap: 1rem; padding: 1rem; flex-wrap: wrap;">
      <div class="card" style="flex:1; min-width:200px; text-align:center;">
        <h3>Registered Users</h3>
        <p id="kpi-registered" style="font-size: 1.5rem; font-weight: bold;">{{ registered_users_count }}</p>
      </div>
      <div class="card" style="flex:1; min-width:200px; text-align:center;">
        <h3>Today Earnings</h3>
        <p id="kpi-earn-today" style="font-size: 1.5rem; font-weight: bold;">₱0.00</p>
      </div>
      <div class="card" style="flex:1; min-width:200px; text-align:center;">
        <h3>Entries Yesterday</h3>
        <p id="kpi-entries-yest" style="font-size: 1.5rem; font-weight: bold;">0</p>
      </div>
    </div>

    <!-- Monthly Earnings + Avg Stay -->
    <div style="display:flex; gap:1rem; padding: 0 1rem 1rem; flex-wrap: wrap; align-items: stretch;">
      <div class="card chart-card" style="flex:1 1 480px; min-width:360px;">
        <div class="chart-title">Monthly Earnings (Cars vs Motorcycles)</div>
        <div class="chart-scroll">
          <div style="min-width:900px;"><canvas id="earningsMonthly" width="900" height="280"></canvas></div>
        </div>
        <div class="comparison-grid">
          <div>Current (<span id="monthly-current-label">-</span>): <span id="monthly-current-value">₱0.00</span></div>
          <div>Previous (<span id="monthly-previous-label">-</span>): <span id="monthly-previous-value">₱0.00</span></div>
          <div>Change: <span id="monthly-delta-value" class="delta">₱0.00</span></div>
        </div>
      </div>
      <div class="card chart-card" style="flex:1 1 420px; min-width:320px;">
        <div class="chart-title">Avg Stay (mins) by Day</div>
        <div class="chart-scroll"><div style="min-width:900px;"><canvas id="avgStayWeekly" width="900" height="260"></canvas></div></div>
      </div>
    </div>

    <!-- Pie + Hourly side-by-side (compact) -->
    <div style="display:flex; gap:1rem; padding: 0 1rem 1rem; flex-wrap: wrap; align-items: stretch;">
      <div class="card" style="flex:0 1 420px; max-width:480px;">
        <div class="chart-title">Current Occupancy</div>
        <div style="position:relative; display:flex; flex-direction:column; align-items:center; gap:.75rem;">
          <canvas id="occProgress" style="max-height:240px;"></canvas>
          <div id="occLegend" style="font-size:.9rem;"></div>
        </div>
      </div>
      <div class="card chart-card" style="flex:1 1 520px; min-width:360px;">
        <div class="chart-title">Entries Today (hourly)</div>
        <div class="chart-scroll"><div style="min-width:900px;"><canvas id="entriesHourly" width="900" height="260"></canvas></div></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  async function fetchSummary(){
    const res = await fetch("{% url 'analytics_summary' %}");
    if (!res.ok) return null;
    return await res.json();
  }

  const fmtPeso = (v)=> '₱' + Number(v||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  const hours = Array.from({length:24}, (_,i)=> i.toString().padStart(2,'0'));
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  const occProgressCtx = document.getElementById('occProgress');
  const occLegend = document.getElementById('occLegend');
  const hourlyCtx = document.getElementById('entriesHourly');
  const earningsMonthlyCtx = document.getElementById('earningsMonthly');
  const avgStayCtx = document.getElementById('avgStayWeekly');
  const monthlyCurrentLabelEl = document.getElementById('monthly-current-label');
  const monthlyCurrentValueEl = document.getElementById('monthly-current-value');
  const monthlyPreviousLabelEl = document.getElementById('monthly-previous-label');
  const monthlyPreviousValueEl = document.getElementById('monthly-previous-value');
  const monthlyDeltaValueEl = document.getElementById('monthly-delta-value');

  let monthlySnapshot = { labels: [], car: [], motor: [], total: [], comparison: {} };

  const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart) {
      if (!chart._occupancyText) return;
      const {ctx, chartArea: {width, height}} = chart;
      const lines = chart._occupancyText.lines || [];
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#333';
      ctx.font = '600 20px sans-serif';
      lines.forEach((line, idx)=>{
        ctx.fillText(line, width / 2, height / 2 + idx * 22);
      });
      ctx.restore();
    }
  };

  const occProgressChart = new Chart(occProgressCtx, {
    type: 'doughnut',
    data: {
      labels: ['Occupied','Available'],
      datasets: [{
        data: [0, 1],
        backgroundColor:['#f4c430','#e0e0e0'],
        borderWidth:0,
        hoverOffset:4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${ctx.parsed} slots` } }
      }
    },
    plugins: [centerTextPlugin]
  });
  occProgressChart._occupancyText = { lines: ['0/0', '0%'] };

  const hourlyChart = new Chart(hourlyCtx, {
    type: 'bar',
    data: { labels: hours, datasets: [{ label: 'Entries', data: Array(24).fill(0), backgroundColor: '#f4c430' }] },
    options: { responsive: false, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });

  const earningsMonthlyChart = new Chart(earningsMonthlyCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Car', data: [], borderColor: '#f4c430', backgroundColor: 'rgba(244,196,48,0.2)', tension: 0.35, fill: true, pointRadius: 3 },
        { label: 'Motorcycle', data: [], borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.2)', tension: 0.35, fill: true, pointRadius: 3 },
        { label: 'Total', data: [], borderColor: '#673ab7', backgroundColor: 'rgba(103,58,183,0.18)', tension: 0.35, fill: true, pointRadius: 3 }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: (ctx)=> `${ctx.dataset.label}: ${fmtPeso(ctx.parsed.y)}`
          }
        }
      }
    }
  });

  const avgStayChart = new Chart(avgStayCtx, {
    type: 'line',
    data: { labels: days, datasets: [{ label: 'Avg Stay (mins)', data: Array(7).fill(0), borderColor: '#009688', backgroundColor: 'rgba(0,150,136,0.2)', tension: 0.35, fill: true, pointRadius: 3 }] },
    options: { responsive: false, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } }
  });

  async function refresh(){
    const js = await fetchSummary(); if (!js) return;
    const t = js.totals || {}; const o = js.occupancy || {}; const h = js.histogramToday || [];
    const ch = js.charts || {};

    const earnTodayEl = document.getElementById('kpi-earn-today');
    if (earnTodayEl) earnTodayEl.innerText = fmtPeso(t.todayEarnings||0);
    const yestEl = document.getElementById('kpi-entries-yest');
    if (yestEl) yestEl.innerText = (t.yesterdayEntries||0);

    const totalOccupied = t.currentlyOccupied || 0;
    const capacityInfo = (o.capacity || {});
    const totalSlots = Math.max(capacityInfo.totalSlots || 0, totalOccupied);
    const availableSlots = Math.max(totalSlots - totalOccupied, 0);

    occProgressChart.data.datasets[0].data = [
      totalOccupied,
      availableSlots > 0 ? availableSlots : 0.0001
    ];
    const percent = totalSlots > 0 ? Math.round((totalOccupied / totalSlots) * 100) : 0;
    occProgressChart._occupancyText = { lines: [`${totalOccupied}/${totalSlots}`, `${percent}%`] };
    occProgressChart.update();
    if (occLegend) {
      occLegend.innerHTML = `
        <div class="occ-legend-row">
          <span><span class="occ-dot occ-car"></span>Car: ${o.car || 0} / ${capacityInfo.carSlots || 0}</span>
          <span><span class="occ-dot occ-motor"></span>Motorcycle: ${o.motorcycle || 0} / ${capacityInfo.motorcycleSlots || 0}</span>
          <span><span class="occ-dot occ-pwd"></span>PWD: ${o.pwd || 0} / ${capacityInfo.pwdSlots || 0}</span>
        </div>`;
    }

    hourlyChart.data.datasets[0].data = (Array.isArray(h) ? h : Array(24).fill(0));
    hourlyChart.update();

    const monthly = ch.monthlyEarnings || {};
    const monthLabels = Array.isArray(monthly.labels) ? monthly.labels : [];
    const carData = Array.isArray(monthly.car) ? monthly.car : [];
    const motorData = Array.isArray(monthly.motorcycle) ? monthly.motorcycle : [];
    const totalData = Array.isArray(monthly.total) ? monthly.total : [];

    earningsMonthlyChart.data.labels = monthLabels;
    earningsMonthlyChart.data.datasets[0].data = carData;
    earningsMonthlyChart.data.datasets[1].data = motorData;
    earningsMonthlyChart.data.datasets[2].data = totalData;
    earningsMonthlyChart.update();

    monthlySnapshot = {
      labels: monthLabels,
      car: carData,
      motor: motorData,
      total: totalData,
      comparison: ch.monthlyComparison || {}
    };

    const comp = monthlySnapshot.comparison || {};
    const currentTotal = typeof comp.currentTotal === 'number' ? comp.currentTotal : 0;
    const previousTotal = typeof comp.previousTotal === 'number' ? comp.previousTotal : 0;
    const diffValue = typeof comp.difference === 'number' ? comp.difference : 0;
    const currentLabel = comp.currentLabel || (monthLabels.slice(-1)[0] || '-');
    const previousLabel = comp.previousLabel || (monthLabels.slice(-2, -1)[0] || '-');

    if (monthlyCurrentLabelEl) monthlyCurrentLabelEl.textContent = currentLabel;
    if (monthlyCurrentValueEl) monthlyCurrentValueEl.textContent = fmtPeso(currentTotal);
    if (monthlyPreviousLabelEl) monthlyPreviousLabelEl.textContent = previousLabel;
    if (monthlyPreviousValueEl) monthlyPreviousValueEl.textContent = fmtPeso(previousTotal);
    if (monthlyDeltaValueEl) {
      const diffText = fmtPeso(Math.abs(diffValue));
      monthlyDeltaValueEl.textContent = `${diffValue >= 0 ? '+' : '-'}${diffText}`;
      monthlyDeltaValueEl.classList.remove('positive', 'negative');
      if (diffValue > 0) monthlyDeltaValueEl.classList.add('positive');
      else if (diffValue < 0) monthlyDeltaValueEl.classList.add('negative');
    }

    const stayArr = Array.isArray(ch.avgStayMinsByDay) ? ch.avgStayMinsByDay : Array(7).fill(0);
    avgStayChart.data.datasets[0].data = stayArr;
    avgStayChart.update();
  }

  await refresh();
  setInterval(refresh, 15000);
</script>
<style>
  .chart-card{ position: relative; }
  .chart-title{ position: sticky; top: 0; text-align: center; font-weight: 700; padding: 8px 0; background: #fff; z-index: 2; }
  .chart-scroll{ overflow-x: auto; }
  .comparison-grid{ display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; padding:0.75rem 0; font-weight:600; }
  .comparison-grid .delta.positive{ color:#2e7d32; }
  .comparison-grid .delta.negative{ color:#c62828; }
  .occ-legend-row{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center; font-size:.9rem; }
  .occ-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:4px; }
  .occ-car{ background:#f4c430; }
  .occ-motor{ background:#4caf50; }
  .occ-pwd{ background:#2196f3; }
</style>
{% endblock %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={% now 'U' %}">
</head>
<body>
    <div class="topbar">
      <div class="brand">
        <span class="brand-name">CYGO Dashboard</span>
      </div>
      <div class="topbar-tools">
        <!-- room for quick actions/search later -->
      </div>
    </div>
    <div class="sidebar">
        <button id="sidebarToggle" class="icon-btn inside" aria-label="Toggle menu">
          <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </button>
        <div class="profile">
            <img id="admin-avatar" src="{% static 'img/profile.png' %}" alt="Profile" class="avatar" style="cursor:pointer;" data-email="{{ user.email }}" data-username="{{ user.username }}">
            <input id="avatar-file" type="file" accept="image/*" style="display:none;" />
            <span class="username">{{ user.username|default:user.email }}</span>
        </div>
        <!-- Avatar modal viewer -->
        <div id="avatarOverlay" class="overlay" aria-hidden="true">
          <img id="avatarFull" class="modal-image" alt="Profile image" />
        </div>
        <!-- Avatar context menu -->
        <div id="avatar-menu" class="context-menu" style="display:none;">
          <div id="avatar-change">Change photo…</div>
        </div>
        <nav style="width:80%; margin:0 auto;">
            {% if user.is_authenticated and user.is_mall_owner %}
                <a href="{% url 'analytics' %}" class="nav-link">Analytics</a>
                <a href="{% url 'report_builder' %}" class="nav-link">Generate Reports</a>
                <a href="{% url 'register_slots' %}" class="nav-link">Register Slots</a>
            {% endif %}
            {% if user.is_authenticated %}
                {% if user.is_admin or user.is_mall_owner %}
                    <a href="{% url 'monitor' %}" class="nav-link">Monitor</a>
                {% endif %}
                {% if user.is_admin and not user.is_mall_owner %}
                    <a href="{% url 'surveillance' %}" class="nav-link">Surveillance</a>
                    <a href="{% url 'pending' %}" class="nav-link">Pending PWD Verification</a>
                    <a href="{% url 'reports' %}" class="nav-link">Reports</a>
                    <a href="{% url 'report_builder' %}" class="nav-link">Generate Reports</a>
                {% endif %}
                {% if user.is_admin or user.is_mall_owner %}
                    <a href="{% url 'database' %}" class="nav-link">Database</a>
                {% endif %}
            {% endif %}
            <a href="{% url 'logout' %}" class="nav-link">Logout</a>
        </nav>
    </div>
    <!-- Collapsed sidebar handle (appears when sidebar is hidden) -->
    <button id="sidebarHandle" class="sidebar-handle" aria-label="Show menu" title="Show menu">
      <span class="dot"></span>
    </button>

    <main>
        {% block content %}{% endblock %}
    </main>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      // Firebase web config (reuse the same values you used on other pages)
      const firebaseConfig = {
        apiKey: "AIzaSyBM__y-An5IX3zyp8HIhDIH_Lwliq7fSrI",
        authDomain: "cygo1-c184c.firebaseapp.com",
        databaseURL: "https://cygo1-c184c-default-rtdb.firebaseio.com",
        projectId: "cygo1-c184c",
        storageBucket: "cygo1-c184c.firebasestorage.app",
        messagingSenderId: "184723022619",
        appId: "1:184723022619:web:5e6bf5b3fc7d0dfc3229be"
      };

      // Cloudinary unsigned upload config
      const CLOUD_NAME = "dy5kbbskp";            // TODO: replace
      const UPLOAD_PRESET = "reports_img";             // or your preset name

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const avatarEl = document.getElementById('admin-avatar');
      const fileEl = document.getElementById('avatar-file');
      let avatarCacheKey = null;

      function emailKey() {
        const email = avatarEl?.getAttribute('data-email') || '';
        const username = avatarEl?.getAttribute('data-username') || '';
        const keySource = username || email;
        // Firebase keys cannot contain . # $ [ ] / \
        return (keySource || 'unknown').replace(/[.#$\[\]\/\\]/g, '_');
      }

      if (avatarEl) {
        avatarCacheKey = `cygo-avatar-${emailKey()}`;
        try {
          const cachedUrl = sessionStorage.getItem(avatarCacheKey);
          if (cachedUrl) {
            avatarEl.src = cachedUrl;
          }
        } catch (_) {}
      }

      // Load existing avatar URL if present
      (async () => {
        try {
          const snap = await get(child(ref(db), `/admins/${emailKey()}/profileImageUrl`));
          if (snap.exists()) {
            const url = snap.val();
            if (url) {
              if (avatarEl && avatarEl.src !== url) {
                avatarEl.src = url;
              }
              if (avatarCacheKey) {
                try { sessionStorage.setItem(avatarCacheKey, url); } catch (_) {}
              }
            }
          }
        } catch (_) {}
      })();

      // Left-click: open modal viewer
      avatarEl?.addEventListener('click', () => {
        const overlay = document.getElementById('avatarOverlay');
        const full = document.getElementById('avatarFull');
        full.src = avatarEl.src;
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
      });

      // Right-click: open context menu with "Change photo"
      const menu = document.getElementById('avatar-menu');
      avatarEl?.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        menu.style.display = 'block';
        menu.style.left = `${e.pageX}px`;
        menu.style.top = `${e.pageY}px`;
      });
      document.addEventListener('click', () => { menu.style.display = 'none'; });
      document.getElementById('avatar-change')?.addEventListener('click', () => {
        menu.style.display = 'none';
        fileEl?.click();
      });

      fileEl?.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          // Upload to Cloudinary unsigned endpoint
          const form = new FormData();
          form.append('file', file);
          form.append('upload_preset', UPLOAD_PRESET);
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });
          const data = await res.json();
          const url = data?.secure_url;
          if (url) {
            if (avatarEl) {
              avatarEl.src = url;
            }
            if (avatarCacheKey) {
              try { sessionStorage.setItem(avatarCacheKey, url); } catch (_) {}
            }
            await set(ref(db, `/admins/${emailKey()}/profileImageUrl`), url);
          } else {
            alert('Upload failed');
          }
        } catch (err) {
          alert('Upload failed');
        } finally {
          fileEl.value = '';
        }
      });

      // Close avatar modal on click
      const avatarOverlay = document.getElementById('avatarOverlay');
      avatarOverlay?.addEventListener('click', () => {
        avatarOverlay.style.display = 'none';
        avatarOverlay.setAttribute('aria-hidden','true');
        const full = document.getElementById('avatarFull');
        full.src = '';
      });

      // Collapsible sidebar toggle
      const toggleBtn = document.getElementById('sidebarToggle');
      const handleBtn = document.getElementById('sidebarHandle');
      toggleBtn?.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-collapsed');
        if (document.body.classList.contains('sidebar-collapsed')) {
          // focus the handle so it’s easy to bring back with keyboard/mouse
          setTimeout(()=> handleBtn?.focus(), 50);
        }
      });
      handleBtn?.addEventListener('click', () => {
        document.body.classList.remove('sidebar-collapsed');
      });
    </script>
    <style>
      .topbar{ position:fixed; inset:0 0 auto 0; height:56px; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 14px; z-index:1200; background: linear-gradient(90deg, #fff7c7 0%, #fff292 60%, #fff7c7 100%); box-shadow: 0 6px 20px rgba(0,0,0,.08); }
      .brand{ position:absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px; color:#1d1d1f; pointer-events:none; }
      .icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:10px; border:none; background:#fff; box-shadow:0 4px 14px rgba(0,0,0,.10); cursor:pointer; transition:transform .12s ease; }
      .icon-btn.inside{ align-self:flex-start; margin-bottom:10px; }
      .icon-btn:hover{ transform: translateY(-1px); }
      .icon-btn .bar{ display:block; width:18px; height:2px; background:#1d1d1f; margin:2px 0; border-radius:2px; }
      .profile{ display:flex; flex-direction:column; align-items:center; }
      .profile .username{ display:block; margin-top:.5rem; max-width: 160px; word-break: break-word; text-align:center; }
      .overlay{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index: 1300; align-items:center; justify-content:center; padding: 1rem; }
      .modal-image{ max-width: 92vw; max-height: 92vh; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
      .context-menu{ position:absolute; z-index:1400; background:#fff; border:1px solid #ccc; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.15); font-size:14px; overflow:hidden; }
      .context-menu div{ padding:10px 14px; cursor:pointer; }
      .context-menu div:hover{ background:#f0f0f0; }
      /* Layout offsets */
      main{ margin-top: 64px; transition: margin-left .18s ease; }
      .sidebar{ transition: transform .2s ease; z-index: 1400; }
      body.sidebar-collapsed .sidebar{ transform: translateX(-110%); }
      body.sidebar-collapsed main{ margin-left: 0; }

      /* Collapsed sidebar handle */
      .sidebar-handle{
        position: fixed; left: 0; top: 72px; z-index: 1450;
        width: 40px; height: 56px; display: none; align-items:center; justify-content:center;
        background: #e8b931; color:#000; border:none; cursor:pointer;
        border-radius: 0 12px 12px 0; box-shadow: 0 8px 22px rgba(0,0,0,.18);
      }
      .sidebar-handle .dot{ width: 6px; height: 24px; border-radius: 3px; background: rgba(0,0,0,.45); display:block; }
      .sidebar-handle:hover{ filter: brightness(.98); }
      body.sidebar-collapsed .sidebar-handle{ display: inline-flex; }
    </style>
</body>
</html>